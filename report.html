<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานยอดขาย (D3) - ระบบสั่งอาหารผ่าน QR Code</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8f9fa;
        }
        
        /* Navbar Active State */
        .navbar-dark .navbar-nav .nav-link.active {
            color: #ffc107;
            font-weight: bold;
        }

        /* Dashboard Cards */
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .icon-box {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            height: 100%;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils me-2"></i> QR Food System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">หน้าหลัก</a></li>
                    <li class="nav-item"><a class="nav-link" href="menu.html">เมนูอาหาร (D1)</a></li>
                    <li class="nav-item"><a class="nav-link" href="status.html">สถานะออเดอร์ (D2)</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">รายงานยอดขาย (D3)</a></li> </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="fw-bold"><i class="fas fa-chart-line me-2"></i> รายงานยอดขายและรายได้</h2>
                <p class="text-muted">Process 3: การชำระเงินและสรุปยอด (ข้อมูลจาก Data Store D3)</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-outline-secondary" onclick="window.print()"><i class="fas fa-print"></i> พิมพ์รายงาน</button>
                <button class="btn btn-success ms-2"><i class="fas fa-file-excel"></i> Export CSV</button>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ยอดขายวันนี้</h6>
                            <h3 class="fw-bold mb-0" id="totalSales">0 ฿</h3>
                            <small class="text-success"><i class="fas fa-arrow-up"></i> +12% จากเมื่อวาน</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">จำนวนออเดอร์</h6>
                            <h3 class="fw-bold mb-0" id="totalOrders">0</h3>
                            <small class="text-muted">รายการที่ชำระเงินแล้ว</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning me-3">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ยอดเฉลี่ยต่อโต๊ะ</h6>
                            <h3 class="fw-bold mb-0" id="avgSales">0 ฿</h3>
                            <small class="text-muted">วิเคราะห์พฤติกรรมลูกค้า</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5 class="card-title mb-4">แนวโน้มรายได้รายชั่วโมง (วันนี้)</h5>
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="card-title mb-4">สัดส่วนประเภทอาหาร</h5>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 rounded-3">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i> ประวัติการชำระเงินล่าสุด (D3 Logs)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Transaction ID</th>
                                <th>เวลา</th>
                                <th>โต๊ะ</th>
                                <th>รายการ</th>
                                <th>วิธีชำระเงิน</th>
                                <th class="text-end pe-4">จำนวนเงิน</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTable">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-center py-3">
                <button class="btn btn-sm btn-link text-decoration-none">ดูรายการทั้งหมด</button>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // 1. Mock Data: ข้อมูลจาก D3 ข้อมูลการชำระเงิน
        const transactions = [
            { id: 'TRX-8801', time: '12:30', table: 'T-05', items: 'ต้มยำกุ้ง, ข้าวสวย', method: 'QR PromptPay', amount: 280 },
            { id: 'TRX-8802', time: '12:45', table: 'T-02', items: 'ข้าวกะเพราหมูสับ', method: 'Cash', amount: 65 },
            { id: 'TRX-8803', time: '13:10', table: 'T-08', items: 'น้ำแข็งใส, ชาไทย', method: 'QR PromptPay', amount: 85 },
            { id: 'TRX-8804', time: '13:15', table: 'T-01', items: 'สเต็กเนื้อ, สลัด', method: 'Credit Card', amount: 450 },
            { id: 'TRX-8805', time: '13:40', table: 'T-04', items: 'ข้าวผัดปู', method: 'QR PromptPay', amount: 120 }
        ];

        // 2. ฟังก์ชันคำนวณสถิติ (Summary Calculation)
        function calculateStats() {
            const total = transactions.reduce((sum, t) => sum + t.amount, 0);
            const count = transactions.length;
            const avg = total / count;

            document.getElementById('totalSales').innerText = total.toLocaleString() + ' ฿';
            document.getElementById('totalOrders').innerText = count;
            document.getElementById('avgSales').innerText = Math.round(avg).toLocaleString() + ' ฿';
        }

        // 3. ฟังก์ชันแสดงตาราง (Render Table)
        function renderTable() {
            const tbody = document.getElementById('transactionTable');
            let html = '';
            
            // เรียงลำดับจากล่าสุดไปเก่าสุด
            transactions.slice().reverse().forEach(t => {
                let badgeClass = t.method === 'Cash' ? 'bg-secondary' : 'bg-primary';
                
                html += `
                    <tr>
                        <td class="ps-4 fw-bold text-muted">#${t.id}</td>
                        <td>${t.time}</td>
                        <td>${t.table}</td>
                        <td class="text-truncate" style="max-width: 150px;">${t.items}</td>
                        <td><span class="badge ${badgeClass} rounded-pill">${t.method}</span></td>
                        <td class="text-end pe-4 fw-bold text-success">+${t.amount} ฿</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // 4. สร้างกราฟด้วย Chart.js
        function initCharts() {
            // กราฟเส้นแสดงรายได้รายชั่วโมง (Sales Trend)
            const ctxSales = document.getElementById('salesChart').getContext('2d');
            new Chart(ctxSales, {
                type: 'line',
                data: {
                    labels: ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00'],
                    datasets: [{
                        label: 'รายได้ (บาท)',
                        data: [500, 1200, 3500, 4200, 2800, 1500], // Mock Data
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // กราฟโดนัทแสดงสัดส่วนสินค้า (Category Share)
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: ['อาหารจานหลัก', 'เครื่องดื่ม', 'ของหวาน'],
                    datasets: [{
                        data: [65, 25, 10], // Mock Data %
                        backgroundColor: ['#0d6efd', '#0dcaf0', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Initialize
        calculateStats();
        renderTable();
        initCharts();

    </script>
</body>
</html>